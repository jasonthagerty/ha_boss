# Multi-stage build for HA Boss MCP Server
# Build stage: Install dependencies and build wheels
FROM python:3.12-slim AS builder

# Set working directory
WORKDIR /build

# Install build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Copy MCP package files
COPY ha_boss_mcp/pyproject.toml ./
COPY ha_boss_mcp/ha_boss_mcp/ ./ha_boss_mcp/

# Install dependencies to a temporary location
RUN pip install --no-cache-dir --upgrade pip setuptools wheel && \
    pip install --no-cache-dir --prefix=/install .

# Runtime stage: Minimal production image
FROM python:3.12-slim

# Set labels
LABEL org.opencontainers.image.title="HA Boss MCP Server" \
      org.opencontainers.image.description="Model Context Protocol server for HA Boss" \
      org.opencontainers.image.vendor="Jason Hagerty" \
      org.opencontainers.image.source="https://github.com/jasonthagerty/ha_boss"

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Create non-root user for security
RUN groupadd -r mcpuser && useradd -r -g mcpuser -u 1001 mcpuser

# Set working directory
WORKDIR /app

# Copy installed dependencies from builder
COPY --from=builder /install /usr/local

# Copy application code
COPY ha_boss_mcp/ha_boss_mcp/ ./ha_boss_mcp/

# Create directories for runtime data (shared with HA Boss)
RUN mkdir -p /app/config /app/data && \
    chown -R mcpuser:mcpuser /app

# Switch to non-root user
USER mcpuser

# Expose port (only used for HTTP/SSE transport)
EXPOSE 8001

# Set entrypoint to use installed console script (avoids module import warnings)
ENTRYPOINT ["ha-boss-mcp"]

# Default command: stdio transport
CMD ["--transport", "stdio"]
