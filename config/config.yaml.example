# HA Boss Configuration
# Copy to config.yaml and customize for your setup

home_assistant:
  # Home Assistant instance URL (uses HA_URL environment variable)
  url: "${HA_URL}"

  # Long-lived access token (uses HA_TOKEN environment variable)
  # Create at: http://your-ha/profile -> Long-Lived Access Tokens
  token: "${HA_TOKEN}"

monitoring:
  # Auto-Discovery: Automatically discover entities from enabled automations/scenes/scripts
  # This is the default and recommended mode - HA Boss will monitor entities that
  # are actually being used in your automations. Manual include/exclude patterns
  # are ADDITIVE to auto-discovered entities (not replacements).
  auto_discovery:
    # Enable auto-discovery from automations, scenes, and scripts
    enabled: true

    # Skip disabled automations during discovery (recommended)
    skip_disabled_automations: true

    # Include entities from scenes
    include_scenes: true

    # Include entities from scripts
    include_scripts: true

    # Periodic refresh interval (seconds, 0 = disabled)
    # Automatically re-scan automations/scenes/scripts hourly
    refresh_interval_seconds: 3600  # 1 hour

    # Event-triggered refresh (on automation/scene/script reload)
    refresh_on_automation_reload: true
    refresh_on_scene_reload: true
    refresh_on_script_reload: true

  # Entity patterns to ADD to auto-discovered entities (glob patterns)
  # Use this to manually include entities not found in automations
  # Example: ["input_boolean.*", "sensor.manual_monitor"]
  include: []

  # Entity patterns to EXCLUDE from final monitored set (glob patterns)
  # Applied after auto-discovery and include patterns
  # Use this to remove noisy entities from monitoring
  exclude:
    - "sensor.time*"
    - "sensor.date*"
    - "sensor.uptime*"
    - "sun.sun"

  # Grace period before considering entity truly unavailable (seconds)
  grace_period_seconds: 300  # 5 minutes

  # Per-entity overrides (optional)
  # Override grace period for specific critical entities
  # entity_overrides:
  #   "sensor.critical_temperature":
  #     grace_period_seconds: 60  # 1 minute for critical sensors

  # Threshold for stale entities (no update in X seconds)
  stale_threshold_seconds: 3600  # 1 hour

  # Periodic REST API snapshot interval (seconds)
  # Used to validate WebSocket cache
  snapshot_interval_seconds: 300  # 5 minutes

healing:
  # Enable auto-healing
  enabled: true

  # Maximum healing attempts per integration
  max_attempts: 3

  # Cooldown between healing attempts (seconds)
  cooldown_seconds: 300  # 5 minutes

  # Circuit breaker threshold (stop trying after N total failures)
  circuit_breaker_threshold: 10

  # Circuit breaker reset time (seconds)
  # After this time with no failures, reset counter
  circuit_breaker_reset_seconds: 3600  # 1 hour

  # Entity-level healing configuration
  entity_healing_max_attempts: 3  # Maximum retry attempts for entity-level healing
  entity_healing_base_delay: 1.0  # Base delay in seconds for exponential backoff

  # Device-level healing configuration
  device_healing_reboot_timeout: 30.0  # Timeout in seconds for device reboot operations

  # Entity state verification after healing
  device_state_verification_timeout: 5.0  # seconds to wait for entities to settle
  device_state_verification_partial_success_threshold: 0.5  # 50% recovery threshold

  # Common integration timing:
  # - Z-Wave/Zigbee: 7-10 seconds (mesh healing)
  # - WiFi devices: 3-5 seconds
  # - Fast integrations (MQTT): 2-3 seconds

  # Example scenarios for different deployment types:
  # - Z-Wave network: timeout=10.0, threshold=0.5 (50% immediate, rest after mesh heal)
  # - WiFi devices: timeout=5.0, threshold=0.8 (expect 80% within 5 seconds)
  # - Mixed network: timeout=7.0, threshold=0.6 (balanced approach)
  # - Fast devices: timeout=3.0, threshold=0.9 (MQTT, local integrations)

notifications:
  # Send notifications when auto-healing fails
  on_healing_failure: true

  # Send weekly summary reports
  weekly_summary: true

  # Home Assistant notification service
  ha_service: "persistent_notification.create"

  # AI-enhanced notifications (Phase 3)
  # Use LLM to generate natural language explanations for failures
  # Requires Ollama or Claude API configured in intelligence section
  ai_enhanced: true

  # Optional: Email notifications
  # email:
  #   enabled: false
  #   smtp_server: "smtp.gmail.com"
  #   smtp_port: 587
  #   username: "your-email@gmail.com"
  #   password: "${EMAIL_PASSWORD}"
  #   from: "haboss@example.com"
  #   to: "your-email@gmail.com"

# Operational mode
# - production: Full auto-healing enabled
# - dry_run: Log actions but don't execute
# - testing: Use test HA instance
mode: "production"

# Logging configuration
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL
  format: "text"  # text (easier to read) or json (structured logging)
  file: "/app/data/ha_boss.log"
  max_size_mb: 10
  backup_count: 5

# Database configuration
database:
  # SQLite database path
  path: "/app/data/ha_boss.db"

  # Enable SQL query logging (debug only)
  echo: false

  # History retention (days)
  # Older records are automatically purged
  retention_days: 30

# WebSocket configuration
websocket:
  # Reconnect delay (seconds)
  reconnect_delay_seconds: 5

  # Heartbeat interval (seconds)
  # Send ping every N seconds to keep connection alive
  heartbeat_interval_seconds: 30

  # Connection timeout (seconds)
  timeout_seconds: 10

# REST API configuration
rest:
  # Request timeout (seconds)
  timeout_seconds: 10

  # Retry attempts for failed requests
  retry_attempts: 3

  # Base delay for exponential backoff (seconds)
  retry_base_delay_seconds: 1.0

# Intelligence layer configuration (Phase 2 & 3)
intelligence:
  # Enable pattern collection for reliability analysis (Phase 2)
  # Tracks healing success rates, failure patterns, and integration health
  pattern_collection_enabled: true

  # Anomaly detection (Phase 3)
  anomaly_detection_enabled: true  # Auto-detect unusual patterns
  anomaly_sensitivity_threshold: 2.0  # Standard deviations (higher = less sensitive)
  anomaly_scan_hours: 24  # Hours of data to scan

  # Local LLM via Ollama (Phase 3)
  # Ollama provides privacy-first AI features running locally
  # Install: https://ollama.ai or run via Docker
  ollama_enabled: true
  ollama_url: "http://localhost:11434"
  ollama_model: "llama3.1:8b"  # Recommended: llama3.1:8b or mistral
  ollama_timeout_seconds: 30

  # Claude API for complex tasks (Phase 3, optional)
  # Used for automation generation and deep analysis
  # Get API key at: https://console.anthropic.com
  claude_enabled: false  # Enable when you have an API key
  claude_api_key: "${CLAUDE_API_KEY}"  # Set in .env file
  claude_model: "claude-3-5-sonnet-20241022"

# Outcome validation configuration (Phase 2)
# Validates that automations achieve their intended outcomes
outcome_validation:
  # Enable automatic outcome validation for automations
  enabled: true

  # Delay before validating outcomes (seconds)
  # Allows states to settle before checking if automation succeeded
  validation_delay_seconds: 5.0

  # Enable AI analysis of reported automation failures
  # Uses LLM to analyze failure patterns and suggest fixes
  # Requires Ollama or Claude configured in intelligence section
  analyze_failures: true

  # Consecutive success threshold for validation gating
  # Number of consecutive successful executions required before marking
  # an automation as "validated healthy" in reliability scoring
  # Range: 1-100, recommended: 3-5
  consecutive_success_threshold: 3

# REST API server configuration
api:
  # Enable the REST API server (required for health checks)
  enabled: true

  # Host and port for the API server
  host: "0.0.0.0"
  port: 8000

  # CORS settings (for web dashboards and WebSocket origin validation)
  # IMPORTANT: WebSocket connections are validated against these origins
  # for security. Restrict in production to prevent cross-site attacks.
  cors_enabled: true
  cors_origins:
    - "*"  # Allow all origins (SECURITY WARNING: only use in trusted networks!)
    # Production examples:
    # - "http://localhost:8000"        # Same-origin only
    # - "http://homeassistant.local:8123"  # Home Assistant dashboard
    # - "https://my-domain.com"        # External dashboard
    # - "http://localhost:*"           # Wildcard port matching

  # Optional: API key authentication
  auth_enabled: false
  api_keys: []
